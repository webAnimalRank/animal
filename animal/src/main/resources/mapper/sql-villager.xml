<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.animal.mapper.VillagerMapper">

    <select id="selectVillagers" resultType="com.example.animal.dto.VillagerList">
        SELECT
            v.villager_no           AS villagerNo,
            v.villager_name         AS villagerName,
            v.villager_image_icon   AS villagerImageIcon
        FROM villager v
        ORDER BY v.villager_no DESC
    </select>

    <select id="selectVillagerByNo"
            parameterType="int"
            resultType="com.example.animal.dto.VillagerDetail">
        SELECT
            v.villager_no           AS villagerNo,
            v.villager_category     AS villagerCategory,
            v.villager_type         AS villagerType,
            tc.type_name            AS villagerTypeName,

            v.villager_name         AS villagerName,
            v.villager_name_en      AS villagerNameEn,
            v.villager_name_jp      AS villagerNameJp,

            v.villager_image        AS villagerImage,
            v.villager_image_icon   AS villagerImageIcon,

            v.villager_birth        AS villagerBirth,
            v.villager_debut        AS villagerDebut,
            v.villager_sex          AS villagerSex,

            v.villager_vote         AS villagerVote
        FROM villager v
        LEFT JOIN villager_type_code tc
            ON v.villager_type = tc.villager_type
        WHERE v.villager_no = #{villagerNo}
    </select>

    <insert id="upsertFromNookipedia">
        INSERT INTO villager (
            villager_category,
            villager_type,
            villager_name,
            villager_name_en,
            villager_image,
            villager_image_icon,
            villager_birth,
            villager_debut,
            villager_sex
        ) VALUES (
            #{category},
            #{type},
            #{name},
            #{nameEn},
            #{imageUrl},
            #{iconUrl},
            #{birth},
            #{debut},
            #{sex}
        )
        ON DUPLICATE KEY UPDATE
            villager_type = VALUES(villager_type),
            villager_name = VALUES(villager_name),
            villager_image = VALUES(villager_image),
            villager_image_icon = VALUES(villager_image_icon),
            villager_birth = VALUES(villager_birth),
            villager_debut = VALUES(villager_debut),
            villager_sex = VALUES(villager_sex);
    </insert>

    <select id="findTypeByEnglishName" resultType="int">
        SELECT villager_type
        FROM villager_type_code
        WHERE type_name_en = #{typeNameEn}
        LIMIT 1
    </select>

    <select id="searchVillagers" resultType="com.example.animal.dto.VillagerList">
        SELECT
            v.villager_no         AS villagerNo,
            v.villager_name       AS villagerName,
            v.villager_image_icon AS villagerImageIcon
        FROM villager v
        <where>
            <if test="type != null">
                AND v.villager_type = #{type}
            </if>

            <if test="sex != null">
                AND v.villager_sex = #{sex}
            </if>

            <if test="birthMonth != null and birthMonth != ''">
                AND LEFT(v.villager_birth, 2) = #{birthMonth}
            </if>

            <if test="keyword != null and keyword != ''">
                AND (
                    v.villager_name LIKE CONCAT('%', #{keyword}, '%')
                    OR v.villager_name_en LIKE CONCAT('%', #{keyword}, '%')
                    OR v.villager_name_jp LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
        </where>
        ORDER BY v.villager_name COLLATE utf8mb4_unicode_ci ASC
    </select>

</mapper>
